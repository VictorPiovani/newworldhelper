<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>New World – Tracker</title>
    <!-- React 18 + Babel standalone (para rodar JSX no navegador) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      :root{
        --bg:#000;
        --tx:#ffb46a; /* laranja suave */
        --tx2:#ffa94d;
        --bd:#ff7a1a;
        --bd2:#ff6a00;
        --warn:#ff6666;
        --ok:#34d399;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;background:var(--bg);color:var(--tx);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;
      }
      .container{max-width:1100px;margin:0 auto;padding:24px}
      .row{display:flex;gap:8px;flex-wrap:wrap}
      .btn{
        padding:8px 12px;border-radius:12px;border:1px solid var(--bd);
        background:#000;color:var(--tx2);cursor:pointer;transition:.15s;
      }
      .btn:hover{background:#1a0c00;border-color:var(--bd2)}
      .card{
        background:rgba(0,0,0,.9);border:1px solid var(--bd);border-radius:16px;
        padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.3)
      }
      .input, select, textarea{
        width:100%;padding:8px 10px;border-radius:12px;border:1px solid #a94c00;
        background:#000;color:#ffd9b2;outline:none
      }
      .input:focus, select:focus, textarea:focus{box-shadow:0 0 0 3px #331a00}
      table{width:100%;border-collapse:collapse}
      th{color:#ffa95f;font-weight:600;text-align:left}
      td,th{padding:8px}
      tr+tr{border-top:1px solid #331a00}
      .tabs{display:flex;gap:8px;margin:12px 0}
      .tab--active{background:#3a1e00;color:#fff;border-color:#ff8a33}
      .muted{color:#ffb97a}
      .deficit{color:var(--warn);font-weight:600}
      .surplus{color:var(--ok);font-weight:600}
      code{background:#1a1a1a;border:1px solid #333;padding:2px 6px;border-radius:6px}
      footer{color:#ff9640;text-align:center;padding:24px 0}
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useEffect, useState } = React;

      // util
      const clsx = (...xs) => xs.filter(Boolean).join(" ");
      const download = (filename, data) => {
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
      };
      const parseJSON = (s) => { try{ return JSON.parse(s) }catch { alert("JSON inválido"); return null } };
      function useLocalStorage(key, initialValue){
        const [value, setValue] = useState(() => {
          try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : initialValue } catch { return initialValue }
        });
        useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(value)) }catch{} }, [key, value]);
        return [value, setValue];
      }

      // dados exemplo
      const SAMPLE_RESOURCES = [
        { id: "orichalcum_ore", name: "Orichalcum Ore", qty: 9927, unit: "un" },
        { id: "cinnabar", name: "Cinnabar", qty: 167, unit: "un" },
        { id: "obsidian_flux", name: "Obsidian Flux", qty: 255, unit: "un" },
        { id: "charcoal", name: "Charcoal", qty: 32, unit: "un" },
      ];
      const SAMPLE_RECIPES = [{
        id: "asmodeum",
        name: "Asmodeum",
        notes: "Receita atual: 5 Orichalcum Ingots, 2 Cinnabar, 1 Obsidian Flux, 2 Charcoal.",
        outputQty: 1,
        inputs: [
          { name: "Orichalcum Ingot", qty: 5 },
          { name: "Cinnabar", qty: 2 },
          { name: "Obsidian Flux", qty: 1 },
          { name: "Charcoal", qty: 2 },
        ],
      }];

      // UI
      const Card = ({className, children}) => <div className={clsx("card", className)}>{children}</div>;
      const Button = ({className, ...p}) => <button className={clsx("btn", className)} {...p} />;
      const Input  = (p) => <input className="input" {...p} />;
      const Textarea = (p) => <textarea className="input" {...p} />;

      function App(){
        const [tab, setTab] = useLocalStorage("nw.tab", "recursos");
        const [resources, setResources] = useLocalStorage("nw.resources", SAMPLE_RESOURCES);
        const [recipes, setRecipes] = useLocalStorage("nw.recipes", SAMPLE_RECIPES);
        const [plan, setPlan] = useLocalStorage("nw.plan", { recipeId: "asmodeum", target: 10 });
        const [filter, setFilter] = useState("");
        const [bulkText, setBulkText] = useState("");
        const [fetchUrl, setFetchUrl] = useState("");

        const resourceMap = useMemo(()=>{
          const m = new Map();
          resources.forEach(r => m.set(r.name.toLowerCase(), r));
          return m;
        }, [resources]);

        const currentRecipe = useMemo(
          () => recipes.find(r => r.id === plan.recipeId) || recipes[0],
          [recipes, plan.recipeId]
        );

        const needs = useMemo(()=>{
          if (!currentRecipe) return [];
          const batches = Math.max(1, Number(plan.target) || 1);
          return currentRecipe.inputs.map(inp => {
            const need = (Number(inp.qty)||0) * batches;
            const have = (resourceMap.get(inp.name.toLowerCase())?.qty||0);
            return { name: inp.name, need, have, deficit: Math.max(0, need - have) };
          });
        }, [currentRecipe, plan.target, resourceMap]);

        const totalDeficit = useMemo(()=>needs.reduce((a,n)=>a+n.deficit,0), [needs]);

        // resources
        const addResource   = () => setResources(p => [...p, { id: crypto.randomUUID(), name: "Novo Recurso", qty: 0, unit: "un" }]);
        const updateResource= (id, patch) => setResources(p => p.map(r => r.id===id? {...r, ...patch}: r));
        const removeResource= (id) => setResources(p => p.filter(r => r.id!==id));

        // recipes
        const addRecipe = () => setRecipes(p => [...p, { id: crypto.randomUUID(), name: "Nova Receita", outputQty: 1, inputs: [{ name:"Item A", qty:1 }] }]);
        const updateRecipe = (id, patch) => setRecipes(p => p.map(r => r.id===id? {...r, ...patch}: r));
        const removeRecipe = (id) => setRecipes(p => p.filter(r => r.id!==id));

        // export/import
        const exportAll = () => download("nw-tracker.json", JSON.stringify({ resources, recipes, plan, version:1 }, null, 2));
        const importAll = (e) => {
          const file = e.target.files?.[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            const data = parseJSON(String(reader.result)); if (!data) return;
            if (data.resources) setResources(data.resources);
            if (data.recipes) setRecipes(data.recipes);
            if (data.plan) setPlan(data.plan);
            alert("Importado com sucesso!");
          };
          reader.readAsText(file);
        };

        // bulk paste
        const applyBulk = () => {
          const lines = bulkText.split(/\n|\r/).map(l=>l.trim()).filter(Boolean);
          const next = [...resources];
          for (const line of lines){
            const m = line.match(/^([0-9]+(?:\.[0-9]+)?)\s+(.+)$/);
            if (!m) continue;
            const qty = Number(m[1]);
            const name = m[2].replace(/\s+/g," ").trim();
            const key = name.toLowerCase();
            const idx = next.findIndex(r => r.name.toLowerCase()===key);
            if (idx>=0) next[idx] = {...next[idx], qty};
            else next.push({ id: crypto.randomUUID(), name, qty, unit:"un" });
          }
          setResources(next);
          setBulkText("");
        };

        // fetch recipe (precisa CORS OK)
        const fetchRecipeFromUrl = async () => {
          if (!fetchUrl) return;
          try{
            const res = await fetch(fetchUrl);
            if (!res.ok) throw new Error("HTTP "+res.status);
            const data = await res.json();
            if (!data.name || !Array.isArray(data.inputs)) throw new Error("Esperado { name, outputQty, inputs[] }");
            setRecipes(p => [...p, { id: crypto.randomUUID(), ...data }]);
            alert("Receita importada!");
          }catch(e){ alert("Falha ao buscar receita (CORS/URL):\n"+e.message); }
        };

        return (
          <div className="container">
            <header className="row" style={{justifyContent:"space-between", alignItems:"center"}}>
              <h1 style="font-weight:800;color:#ffa44d;margin:0">New World – Tracker de Recursos & Crafts</h1>
              <div className="row">
                <Button onClick={exportAll}>Exportar backup</Button>
                <label className="btn" style={{display:"inline-block"}}>
                  <input type="file" accept="application/json" style="display:none" onChange={importAll} />
                  Importar backup
                </label>
              </div>
            </header>

            <nav className="tabs">
              {[
                { id:"recursos", label:"Recursos" },
                { id:"receitas", label:"Receitas" },
                { id:"planejamento", label:"Planejamento" },
                { id:"config", label:"Config/Import" },
              ].map(t => (
                <Button key={t.id}
                  className={clsx(tab===t.id && "tab--active")}
                  onClick={()=>setTab(t.id)}
                >{t.label}</Button>
              ))}
            </nav>

            {tab==="recursos" && (
              <Card>
                <div className="row" style={{justifyContent:"space-between", alignItems:"center", marginBottom:12}}>
                  <h2 style="margin:0;color:#ffb870">Inventário de Recursos</h2>
                  <div className="row">
                    <Input placeholder="Filtrar por nome…" value={filter} onChange={e=>setFilter(e.target.value)} />
                    <Button onClick={addResource}>Adicionar recurso</Button>
                  </div>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Nome</th><th class="w-32">Qtd</th><th class="w-28">Unidade</th><th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {resources
                        .filter(r => r.name.toLowerCase().includes(filter.toLowerCase()))
                        .sort((a,b)=>a.name.localeCompare(b.name))
                        .map(r=>(
                        <tr key={r.id}>
                          <td><Input value={r.name} onChange={e=>updateResource(r.id,{name:e.target.value})} /></td>
                          <td><Input type="number" value={r.qty} onChange={e=>updateResource(r.id,{qty:Number(e.target.value)})} /></td>
                          <td><Input value={r.unit||"un"} onChange={e=>updateResource(r.id,{unit:e.target.value})} /></td>
                          <td><Button className="warn" onClick={()=>removeResource(r.id)} style={{borderColor:"#7a1a1a", color:"#ff6666"}}>Remover</Button></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </Card>
            )}

            {tab==="receitas" && (
              <div className="row" style={{gap:16}}>
                <div style="flex:1 1 620px">
                  <Card>
                    <div className="row" style={{justifyContent:"space-between", alignItems:"center", marginBottom:12}}>
                      <h2 style="margin:0;color:#ffb870">Receitas</h2>
                      <Button onClick={addRecipe}>Adicionar receita</Button>
                    </div>
                    <div className="column" style={{display:"grid", gap:12}}>
                      {recipes.map(rec=>(
                        <Card key={rec.id}>
                          <div className="row" style={{gap:12, flexWrap:"wrap"}}>
                            <div style="flex:1 1 260px">
                              <small class="muted">Nome</small>
                              <Input value={rec.name} onChange={e=>updateRecipe(rec.id,{name:e.target.value})} />
                            </div>
                            <div style="flex:1 1 160px;max-width:220px">
                              <small class="muted">Saída (por craft)</small>
                              <Input type="number" value={rec.outputQty||1} onChange={e=>updateRecipe(rec.id,{outputQty:Number(e.target.value)||1})}/>
                            </div>
                            <div style="flex-basis:100%"></div>
                            <div style="flex:1 1 100%">
                              <small class="muted">Observações</small>
                              <Input value={rec.notes||""} onChange={e=>updateRecipe(rec.id,{notes:e.target.value})}/>
                            </div>
                            <div style="flex-basis:100%"></div>
                            <div style="flex:1 1 100%">
                              <small class="muted">Insumos</small>
                              <div style="display:grid;gap:8px">
                                {(rec.inputs||[]).map((inp,idx)=>(
                                  <div key={idx} className="row" style={{gap:8}}>
                                    <div style="flex:1 1 auto">
                                      <Input value={inp.name} onChange={e=>{
                                        const inputs=[...rec.inputs]; inputs[idx]={...inp,name:e.target.value};
                                        updateRecipe(rec.id,{inputs});
                                      }}/>
                                    </div>
                                    <div style="width:120px">
                                      <Input type="number" value={inp.qty} onChange={e=>{
                                        const inputs=[...rec.inputs]; inputs[idx]={...inp,qty:Number(e.target.value)};
                                        updateRecipe(rec.id,{inputs});
                                      }}/>
                                    </div>
                                    <Button onClick={()=>{
                                      const inputs = rec.inputs.filter((_,i)=>i!==idx);
                                      updateRecipe(rec.id,{inputs});
                                    }} style={{borderColor:"#7a1a1a", color:"#ff6666"}}>Remover</Button>
                                  </div>
                                ))}
                                <Button onClick={()=>updateRecipe(rec.id,{inputs:[...(rec.inputs||[]),{name:"Novo Insumo", qty:1}]})}>+ Insumo</Button>
                              </div>
                            </div>
                          </div>
                          <div className="row" style={{justifyContent:"space-between", marginTop:10}}>
                            <Button onClick={()=>removeRecipe(rec.id)} style={{borderColor:"#7a1a1a", color:"#ff6666"}}>Excluir receita</Button>
                          </div>
                        </Card>
                      ))}
                    </div>
                  </Card>
                </div>
                <div style="flex:1 1 320px;min-width:300px">
                  <Card>
                    <h3 style="margin:0 0 8px;color:#ffb870">Importar receita por URL</h3>
                    <p class="muted">Esperado JSON: <code>{`{ name, outputQty, inputs:[{name, qty}] }`}</code>. Atenção a CORS.</p>
                    <Input placeholder="https://exemplo.com/receita.json" value={fetchUrl} onChange={e=>setFetchUrl(e.target.value)} />
                    <div style="margin-top:8px"><Button onClick={fetchRecipeFromUrl}>Buscar</Button></div>
                    <hr style="border-color:#1f0f00;margin:16px 0" />
                    <h3 style="margin:0 0 8px;color:#ffb870">Dica</h3>
                    <p class="muted">Crie receitas manualmente ou hospede seus próprios JSONs no GitHub (CORS ok).</p>
                  </Card>
                </div>
              </div>
            )}

            {tab==="planejamento" && (
              <div className="row" style={{gap:16}}>
                <div style="flex:1 1 620px">
                  <Card>
                    <h2 style="margin:0 0 12px;color:#ffb870">Planejamento de Craft</h2>
                    <div className="row" style={{gap:12, flexWrap:"wrap"}}>
                      <div style="flex:1 1 320px">
                        <small class="muted">Receita</small>
                        <select value={plan.recipeId} onChange={e=>setPlan({...plan, recipeId:e.target.value})}>
                          {recipes.map(r=><option key={r.id} value={r.id}>{r.name}</option>)}
                        </select>
                      </div>
                      <div style="width:180px">
                        <small class="muted">Quantidade desejada</small>
                        <Input type="number" value={plan.target} onChange={e=>setPlan({...plan, target:Number(e.target.value)||1})}/>
                      </div>
                    </div>

                    {currentRecipe && (
                      <div style="margin-top:16px">
                        <h3 style="margin:0 0 6px;color:#ffb870">Insumos necessários</h3>
                        <div style="overflow:auto">
                          <table>
                            <thead><tr><th>Recurso</th><th>Necessário</th><th>Tenho</th><th>Déficit</th></tr></thead>
                            <tbody>
                              {needs.map(n=>(
                                <tr key={n.name}>
                                  <td>{n.name}</td>
                                  <td>{n.need}</td>
                                  <td>{n.have}</td>
                                  <td className={n.deficit>0 ? "deficit":"surplus"}>{n.deficit}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                        <div class="muted" style="margin-top:8px">
                          Déficit total: <strong style="color:#ffa44d">{totalDeficit}</strong>
                        </div>
                      </div>
                    )}
                  </Card>
                </div>
                <div style="flex:1 1 320px;min-width:300px">
                  <Card>
                    <h3 style="margin:0 0 8px;color:#ffb870">Ações rápidas</h3>
                    <div className="row" style={{flexDirection:"column", gap:8}}>
                      <Button onClick={()=>{
                        if (!currentRecipe) return;
                        const batches = Math.max(1, Number(plan.target) || 1);
                        const needed = currentRecipe.inputs.map(i=>({name:i.name.toLowerCase(), qty:(Number(i.qty)||0)*batches}));
                        const next = resources.map(r=>({...r}));
                        for (const need of needed){
                          const idx = next.findIndex(r=>r.name.toLowerCase()===need.name);
                          if (idx>=0) next[idx].qty = Math.max(0, Number(next[idx].qty) - need.qty);
                        }
                        setResources(next);
                        alert("Inventário atualizado (consumo simulado)");
                      }}>Consumir do inventário</Button>
                      <Button onClick={()=>setPlan({...plan, target:10})}>Meta rápida: 10 un</Button>
                      <Button onClick={()=>setPlan({...plan, target:25})}>Meta rápida: 25 un</Button>
                    </div>
                    <hr style="border-color:#1f0f00;margin:16px 0" />
                    <h3 style="margin:0 0 8px;color:#ffb870">Observações</h3>
                    <ul style="margin:0;padding-left:18px">
                      <li class="muted">Roda 100% no cliente (GitHub Pages).</li>
                      <li class="muted">Dados salvos no <b>localStorage</b> (exporte/import para backup).</li>
                      <li class="muted">Para buscar receitas externas, prefira JSON público (ou use proxy por causa de CORS).</li>
                    </ul>
                  </Card>
                </div>
              </div>
            )}

            {tab==="config" && (
              <div className="row" style={{gap:16}}>
                <div style="flex:1 1 520px">
                  <Card>
                    <h3 style="margin:0 0 8px;color:#ffb870">Importar inventário em massa (texto)</h3>
                    <p class="muted">Formato por linha: <code>quantidade nome do recurso</code> (ex.: <code>9927 Orichalcum Ore</code>)</p>
                    <Textarea rows="8" placeholder={"Exemplo:\n9927 Orichalcum Ore\n167 Cinnabar\n255 Obsidian Flux"} value={bulkText} onChange={e=>setBulkText(e.target.value)} />
                    <div className="row" style={{gap:8, marginTop:8}}>
                      <Button onClick={applyBulk}>Aplicar</Button>
                      <Button onClick={()=>setBulkText("")} style={{borderColor:"#7a1a1a", color:"#ff6666"}}>Limpar</Button>
                    </div>
                  </Card>
                </div>
                <div style="flex:1 1 320px;min-width:300px">
                  <Card>
                    <h3 style="margin:0 0 8px;color:#ffb870">Estado & Reset</h3>
                    <div className="row" style={{flexDirection:"column", gap:8}}>
                      <Button onClick={()=>{ if(confirm("Zerar recursos?")) setResources([]) }}>Zerar recursos</Button>
                      <Button onClick={()=>{ if(confirm("Zerar receitas?")) setRecipes([]) }}>Zerar receitas</Button>
                      <Button onClick={()=>{ if(confirm("Reset total (inclui plano e abas)?")) { localStorage.clear(); location.reload() } }}>Reset total</Button>
                    </div>
                  </Card>
                </div>
              </div>
            )}

            <footer>Dark Orange Theme • Salvo em localStorage • GitHub Pages</footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
